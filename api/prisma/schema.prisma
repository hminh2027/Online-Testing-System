generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  fullname  String
  password  String    @db.LongText
  isTeacher Boolean   @default(false)
  phone     String?
  birth     DateTime?
  school    String?
  studentId String?   @unique
  imageUrl  String?
  createdAt DateTime  @default(now())

  // relations
  Classes           Class[]
  Exam              Exam[]
  Attempt           Attempt[]
  Post              Post[]
  Comment           Comment[]
  Notification      Notification[]
  User_Notification User_Notification[]
  UserClass         UserClass[]
}

model UserClass {
  id Int @id @default(autoincrement())

  studentId Int
  classCode String
  isPending Boolean
  createdAt DateTime @default(now())
  // relations
  User      User     @relation(fields: [studentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Class     Class    @relation(fields: [classCode], references: [code], onDelete: Cascade, onUpdate: Cascade)

  @@unique([studentId, classCode])
}

model Class {
  code                   String      @id
  teacherId              Int
  name                   String
  imageUrl               String?
  description            String?     @db.LongText
  password               String?
  isStudentApprovalEnter Boolean     @default(false)
  isStudentApprovalLeave Boolean     @default(false)
  isStudentPostAllowed   Boolean     @default(true)
  isActive               Boolean     @default(true)
  createdAt              DateTime    @default(now())
  // relations
  ClassExam              ClassExam[]
  Post                   Post[]
  UserClass              UserClass[]
  User                   User        @relation(fields: [teacherId], references: [id])
}

model Exam {
  id                        Int         @id @default(autoincrement())
  teacherId                 Int
  title                     String
  description               String?     @db.LongText
  duration                  Int
  numberOfQuestionDisplayed Int         @default(1)
  createdAt                 DateTime    @default(now())
  // relations
  User                      User        @relation(fields: [teacherId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  ClassExam                 ClassExam[]
  Question                  Question[]
  Attempt                   Attempt[]
}

model Question {
  id       Int      @id @default(autoincrement())
  examId   Int
  index    Int
  imageUrl String?  @db.LongText
  content  String   @db.LongText
  score    Int
  // relations
  Exam     Exam     @relation(fields: [examId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Answer   Answer[]
  Choice   Choice[]
}

model Answer {
  id         Int      @id @default(autoincrement())
  questionId Int
  index      Int
  content    String   @db.LongText
  isCorrect  Boolean  @default(false)
  // relations
  Question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Choice     Choice[]
}

model ClassExam {
  id           Int       @id @default(autoincrement())
  classCode    String
  examId       Int
  startTime    DateTime  @default(now())
  deadlineAt   DateTime?
  attemptLimit Int?      @default(0)
  isSubmitLate Boolean?  @default(true)
  isShuffle    Boolean?  @default(false)
  isShowAnswer Boolean?  @default(true)
  createdAt    DateTime  @default(now())
  // relations
  Class        Class     @relation(fields: [classCode], references: [code], onDelete: Cascade, onUpdate: Cascade)
  Exam         Exam      @relation(fields: [examId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Attempt {
  id                        Int       @id @default(autoincrement())
  studentId                 Int
  examId                    Int
  startedAt                 DateTime  @default(now())
  endedAt                   DateTime?
  score                     Float?
  numberOfQuestionDisplayed Int       @default(0)
  // relations
  User                      User      @relation(fields: [studentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Exam                      Exam      @relation(fields: [examId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Choice                    Choice[]
}

model Choice {
  id            Int      @id @default(autoincrement())
  attemptId     Int
  questionIndex Int
  answerIndex   Int
  // relations
  Attempt       Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Question      Question @relation(fields: [questionIndex], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Answer        Answer   @relation(fields: [answerIndex], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Post {
  id        Int       @id @default(autoincrement())
  userId    Int
  classCode String
  content   String
  imageUrl  String?   @db.LongText
  createdAt DateTime  @default(now())
  // relations
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Class     Class     @relation(fields: [classCode], references: [code], onDelete: Cascade, onUpdate: Cascade)
  Comment   Comment[]
}

model Comment {
  id        Int      @id @default(autoincrement())
  userId    Int
  postId    Int
  content   String
  createdAt DateTime @default(now())
  // relations
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Notification {
  id                Int                 @id @default(autoincrement())
  userId            Int
  content           String
  url               String
  createdAt         DateTime            @default(now())
  // relations
  User              User                @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  User_Notification User_Notification[]
}

model User_Notification {
  id           Int          @id @default(autoincrement())
  notiId       Int
  userId       Int
  isRead       Boolean      @default(false)
  // relations
  Notification Notification @relation(fields: [notiId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}
